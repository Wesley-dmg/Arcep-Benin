
{% extends 'layouts/base.html' %}

{% block title %} Cartographie des Sites {% endblock title %}

{% block stylesheets %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@1.6.0/Control.FullScreen.css" />
{% comment %} <link rel="stylesheet" href="/static/assets/css/leaflet.css" /> {% endcomment %}
{% comment %} <link rel="stylesheet" href="/static/assets/css/FullScreen.css" /> {% endcomment %}
<style>
    .map-canvas {
        height: 100vh;
        width: 100%;
    }
    .custom-marker {
    display: flex;
    align-items: center;
    justify-content: center;
}
    .sidebar {
    transition: right 0.3s ease-in-out;
}
</style>
{% endblock %}

{% block content %}
<div class="header bg-primary pb-6">
    <div class="container-fluid">
        <div class="header-body">
            <div class="row align-items-center py-4">
                <div class="col-lg-6 col-7">
                    <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
                        <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
                            <li class="breadcrumb-item"><a href="#"><i class="fas fa-home"></i></a></li>
                            <li class="breadcrumb-item"><a href="#">Cartographie</a></li>
                        </ol>
                    </nav>
                </div>
                <div class="col-lg-6 col-5 text-right">
                    <!-- Toggler button for filter sidebar -->
                    <button id="filterToggle" class="btn btn-sm btn-neutral"><i class="fas fa-filter"></i> Filtres</button>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Full-height Sidebar for Filters -->
<!-- Full-height Sidebar for Filters -->
<div id="filterSidebar" class="sidebar bg-light border-right" style="width: 250px; height: 100vh; position: fixed; top: 190px; right: -250px; overflow-y: auto; transition: 0.3s; z-index: 1000;">
    <!-- Close "X" Button -->
    <button id="closeSidebar" class="close-btn" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px;">&times;</button>
    <div class="p-4">
        <h5>Filtrer les sites</h5>
        
        <form id="filterForm">
            <!-- Bouton de réinitialisation des filtres -->
            <button type="button" id="resetFilters" class="btn btn-secondary mt-3">Réinitialiser</button>
            <div class="form-group">
                <label for="departement">Département</label>
                <select id="departement" name="departement" class="form-control">
                    <option value="">Tous</option>
                    {% for departement in departements %}
                    <option value="{{ departement.id }}">{{ departement.nom }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group d-none">
                <label for="commune">Commune</label>
                <select id="commune" name="commune" class="form-control">
                    <option value="">Toutes</option>
                    {% for commune in communes %}
                    <option value="{{ commune.id }}">{{ commune.nom }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="operateur">Opérateur</label>
                <select id="operateur" name="operateur" class="form-control">
                    <option value="">Tous</option>
                    {% for operateur in operateurs %}
                    <option value="{{ operateur.id }}">{{ operateur.nom }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Conformité</label>
                <div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="conformite" id="conforme" value="conforme">
                        <label class="form-check-label" for="conforme">Conforme</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="conformite" id="nonConforme" value="non-conforme">
                        <label class="form-check-label" for="nonConforme">Non Conforme</label>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>


<!-- Main Map Section -->
<div class="container-fluid mt--6">
    <div class="row">
        <div class="col">
            <div class="card border-0">
                <div id="carteSite" class="map-canvas"></div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
{% comment %} <script src="/static/assets/js/leaflet.js"></script> {% endcomment %}

<script src="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@1.6.0/Control.FullScreen.min.js"></script>
{% comment %} <script src="/static/assets/js/FullScreen.min.js"></script> {% endcomment %}
<!-- JavaScript for Toggle Sidebar -->
<script>
    
    document.addEventListener('DOMContentLoaded', function() {
    // Les éléments de filtre
    const departementFilter = document.getElementById('departement');
    const communeFilter = document.getElementById('commune');
    const operateurFilter = document.getElementById('operateur');
    const conformiteFilters = document.querySelectorAll('input[name="conformite"]');
    const resetButton = document.getElementById('resetFilters');
    
    applyFilters();
    // Initialisation de la carte
        var map = L.map('carteSite', { fullscreenControl: true }).setView([9.3077, 2.3158], 9);

    // Ajouter une couche de tuiles OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Vérifie que la carte est bien définie
    if (typeof map === 'undefined') {
        console.error('La carte n\'est pas définie');
        return;
    }

    // Fonction pour appliquer les filtres et actualiser la carte
    function applyFilters() {
        const departement = departementFilter.value;
        const commune = communeFilter.value;
        const operateur = operateurFilter.value;
        let conformite = '';
        
        conformiteFilters.forEach((radio) => {
            if (radio.checked) {
                conformite = radio.value;
            }
        });

        const url = `/map/?departement=${departement}&commune=${commune}&operateur=${operateur}&conformite=${conformite}`;

        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest' // Indique une requête AJAX
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data && data.sites) {
                updateMap(data.sites); // Mise à jour de la carte avec les marqueurs filtrés
            } else {
                alert("Erreur : Aucune donnée disponible.");
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors de la récupération des données.');
        });
    }

    // Fonction pour mettre à jour la carte
    function updateMap(sites) {
        // Vérification pour s'assurer que "sites" est bien un tableau
    if (!Array.isArray(sites)) {
        console.error('Les données reçues ne sont pas valides:', sites);
        return;
    }
    // Supprimer tous les marqueurs actuels de la carte
        map.eachLayer(function(layer) {
            if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
                map.removeLayer(layer);
            }
        });

        const bounds = [];
        sites.forEach(site => {
            const latitude = parseFloat(site.latitude);
            const longitude = parseFloat(site.longitude);

            if (!isNaN(latitude) && !isNaN(longitude)) {
                bounds.push([latitude, longitude]);

                const iconColor = site.icon_color;
                const icon = L.divIcon({
                    html: `<i class="fas fa-map-marker-alt" style="color: ${iconColor}; font-size: 24px;"></i>`,
                    className: 'custom-marker',
                    iconSize: [24, 24],
                    iconAnchor: [12, 24]
                });

                const marker = L.marker([latitude, longitude], { icon: icon });
                marker.bindPopup(`
                    <div>
                        <img src="${site.operateur_logo}" alt="${site.operateur_nom}" style="width: 20px; height: auto;">
                        <b>${site.nom}</b><br>
                        ${site.localite}<br>
                        <a href="/site/${site.id}" class="btn btn-sm">
                            <i class="fa fa-info-circle"></i>
                        </a>
                    </div>
                `);
                marker.addTo(map);
            }
        });

        if (bounds.length > 0) {
            map.fitBounds(bounds, { padding: [20, 20] });
        }
    }

    // Écouteurs pour chaque filtre
    departementFilter.addEventListener('change', applyFilters);
    communeFilter.addEventListener('change', applyFilters);
    operateurFilter.addEventListener('change', applyFilters);
    conformiteFilters.forEach(radio => radio.addEventListener('change', applyFilters));

    // Écouteur pour le bouton de réinitialisation
    resetButton.addEventListener('click', function() {
        document.getElementById('filterForm').reset();
            applyFilters(); // Réapplique les filtres (sans valeurs sélectionnées) pour afficher tous les sites
        });
    });

    document.getElementById('filterToggle').addEventListener('click', function() {
        var sidebar = document.getElementById('filterSidebar');
        var mapElement = document.getElementById('carteSite'); // Cibler l'élément de la carte

        if (sidebar.style.right === '-250px') {
            sidebar.style.right = '0'; // Ouvrir la barre latérale
            mapElement.style.marginRight = '250px'; // Déplacer la carte vers la gauche
        } else {
            sidebar.style.right = '-250px'; // Fermer la barre latérale
            mapElement.style.marginRight = '0'; // Réinitialiser la position de la carte
        }
    });

    document.getElementById('closeSidebar').addEventListener('click', function() {
        var sidebar = document.getElementById('filterSidebar');
        var mapElement = document.getElementById('carteSite');
        sidebar.style.right = '-250px'; // Fermer la barre latérale
        mapElement.style.marginRight = '0'; // Réinitialiser la position de la carte
    });
</script>

{% endblock javascripts %}
