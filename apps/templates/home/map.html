
{% extends 'layouts/base.html' %}

{% block title %} Cartographie des Sites {% endblock title %}

{% block stylesheets %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@1.6.0/Control.FullScreen.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
{% comment %} <link rel="stylesheet" href="/static/assets/css/leaflet.css" /> {% endcomment %}
{% comment %} <link rel="stylesheet" href="/static/assets/css/FullScreen.css" /> {% endcomment %}
<style>
    .map-canvas {
        height: 100vh;
        width: 100%;
    }
    .custom-marker {
    display: flex;
    align-items: center;
    justify-content: center;
    }
    .sidebar {
    transition: right 0.3s ease-in-out;
 }
</style>
{% endblock %}

{% block content %}
<div class="header bg-primary pb-6">
    <div class="container-fluid">
        <div class="header-body">
            <div class="row align-items-center py-3">
                <div class="col-lg-6 col-7">
                    <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
                        <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
                            <li class="breadcrumb-item"><a href="#"><i class="fas fa-home"></i></a></li>
                            <li class="breadcrumb-item"><a href="#">Cartographie</a></li>
                        </ol>
                    </nav>
                </div>
                <div class="col-lg-6 col-5 text-right">
                    <!-- Toggler button for filter sidebar -->
                    <button id="filterToggle" class="btn btn-sm btn-neutral"><i class="fas fa-filter"></i> Filtres</button>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Full-height Sidebar for Filters -->
<div id="filterSidebar" class="sidebar bg-primary text-white border-right" style="width: 300px; height: 100vh; position: fixed; top: 0px; right: -300px; overflow-y: auto; transition: 0.3s; z-index: 1000;">
    <!-- Close "X" Button -->
    <button id="closeSidebar" class="close-btn text-white" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px;">&times;</button>
    <div class="p-4">
        <h5 class="text-white" >Filtrer les sites</h5>
        
        <form id="filterForm">
            <!-- Bouton de réinitialisation des filtres -->
            <button type="button" id="resetFilters" class="btn btn-secondary mt-3">Réinitialiser</button>
            <div class="form-group">
                <label for="departement">Département</label>
                <select id="departement" name="departement" class="form-control select2" data-placeholder="selectionnez Départements" multiple>
                    {% for departement in departements %}
                    <option value="{{ departement.id }}">{{ departement.nom }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="commune">Communes</label>
                <select id="commune" name="commune" class="form-control select2" data-placeholder="selectionnez Communes" multiple >
                    
                </select>
            </div>

            <div class="form-group">
                <label for="operateur">Opérateur</label>
                <select id="operateur" name="operateur" class="form-control select2" multiple data-placeholder="selectionnez operateurs">
                    
                    {% for operateur in operateurs %}
                    <option value="{{ operateur.id }}">{{ operateur.nom }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Filtre Conformité -->
            
            <div class="form-group mt-4">
                <label class="mb-2">Conformité</label>
                <div id="conformiteContainer">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="conforme" name="conformite" value="conforme">
                        <label class="form-check-label" for="conforme">Conforme</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="nonConforme" name="conformite" value="non-conforme">
                        <label class="form-check-label" for="nonConforme">Non Conforme</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sansConformite" name="conformite" value="sans-rapport">
                        <label class="form-check-label" for="sansConformite">Sans Conformité</label>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Main Map Section -->
<div class="container-fluid mt--7">
    <div class="row">
        <div class="col">
            <div class="card border-0">
                <div id="carteSite" class="map-canvas"></div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
{% comment %} <script src="/static/assets/js/leaflet.js"></script> {% endcomment %}
<script src="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@1.6.0/Control.FullScreen.min.js"></script>
{% comment %} <script src="/static/assets/js/FullScreen.min.js"></script> {% endcomment %}
<!-- Initialisation de Select2 -->
<script>
$(document).ready(function() {
    $('select.select2').each(function() {
        const placeholder = $(this).data('placeholder') || 'Veuillez sélectionner une option'; // Valeur par défaut
        $(this).select2({
            placeholder: placeholder,
            allowClear: true
        });
    });
});
</script>

<!-- Initialisation de la carte -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const mapElement = document.getElementById('carteSite');
        if (!mapElement) {
            console.error("L'élément avec l'ID 'carteSite' n'existe pas.");
            return;
        }

        // Initialisation de la carte
        var map = L.map('carteSite').setView([9.3, 2.3], 7);

        L.control.fullscreen({
            position: 'topleft',
            title: "Plein écran",
            titleCancel: "Quitter le plein écran"
        }).addTo(map);

        // Ajouter une couche de tuiles OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        window.map = map; // Exposer la carte globalement
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const departementFilter = document.getElementById('departement');
    const communeFilter = document.getElementById('commune');

    // Fonction pour récupérer les communes dynamiquement
    function fetchCommunes(departementIds) {
        // Si aucun département n'est sélectionné, réinitialiser les communes
        if (!Array.isArray(departementIds) || departementIds.length === 0) {
            updateCommunes([]);
            return;
        }

        // Préparer les paramètres pour la requête AJAX
        const params = new URLSearchParams();
        departementIds.forEach(id => params.append('departement_id[]', id));

        fetch(`/get_communes/?${params.toString()}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erreur HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Communes récupérées :', data); // Debug pour vérifier les données reçues
            updateCommunes(data);
        })
        .catch(error => {
            console.error('Erreur lors de la récupération des communes :', error);
            alert('Une erreur est survenue lors de la récupération des communes.');
        });
    }

    // Fonction pour mettre à jour la liste des communes dans le sélecteur
    function updateCommunes(communes) {
        // Réinitialiser les options du sélecteur des communes
        communeFilter.innerHTML = '<option value="">Tous</option>';
        if (communes && communes.length > 0) {
            communes.forEach(commune => {
                const option = document.createElement('option');
                option.value = commune.id;
                option.textContent = commune.nom;
                communeFilter.appendChild(option);
            });
        }

        // Rafraîchir l'affichage de Select2
        $('#commune').val(null).trigger('change'); // Réinitialiser la sélection
        $('#commune').select2(); // Réactiver Select2
    }

    // Gestion de l'événement de changement sur le filtre département
    $('#departement').on('change', function () {
        const selectedDepartments = $('#departement').val() || [];
        console.log('Départements sélectionnés :', selectedDepartments); // Debug
        fetchCommunes(selectedDepartments);
    });
});
</script>

<!-- Gestion des filtres -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Sélection des éléments de filtre
    const conformiteFilters = document.querySelectorAll('input[name="conformite"]');
    const resetButton = document.getElementById('resetFilters');

    // Fonction pour appliquer les filtres
    function applyFilters() {
        const params = new URLSearchParams();

        // Récupération des valeurs de Select2
        const departements = $('#departement').val() || [];
        const communes = $('#commune').val() || [];
        const operateurs = $('#operateur').val() || [];

        // Récupération des valeurs des cases à cocher
        const conformites = Array.from(conformiteFilters)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => checkbox.value);

        // Ajout des filtres aux paramètres de l'URL
        departements.forEach(dep => params.append('departement', dep));
        communes.forEach(commune => params.append('commune', commune));
        operateurs.forEach(op => params.append('operateur', op));
        conformites.forEach(conf => params.append('conformite', conf));

        const url = `/map/?${params.toString()}`;

        console.log('URL générée:', url);

        // Requête AJAX pour récupérer les données
        fetch(url, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data && data.sites) {
                console.log('Données reçues:', data);
                updateMap(data.sites);
            } else {
                alert("Aucune donnée trouvée pour les filtres appliqués.");
            }
        })
        .catch(error => {
            console.error('Erreur lors de la récupération des données:', error);
            alert('Une erreur est survenue. Veuillez réessayer.');
        });
      }

    // Fonction pour mettre à jour la carte
    function updateMap(sites) {
        const map = window.map; // Utilise la carte globale

        // Supprimer les anciens marqueurs
        map.eachLayer(layer => {
            if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
                map.removeLayer(layer);
            }
        });

        const bounds = [];
        sites.forEach(site => {
            const latitude = parseFloat(site.latitude);
            const longitude = parseFloat(site.longitude);

            if (!isNaN(latitude) && !isNaN(longitude)) {
                bounds.push([latitude, longitude]);

                // Création de l'icône du marqueur
                const icon = L.divIcon({
                    html: `<i class="fas fa-map-marker-alt" style="color: ${site.icon_color}; font-size: 24px;"></i>`,
                    className: 'custom-marker',
                    iconSize: [24, 24],
                    iconAnchor: [12, 24]
                });

                // Création du marqueur avec popup
                const marker = L.marker([latitude, longitude], { icon: icon });
                marker.bindPopup(`
                    <div>
                        <img src="/static/${site.operateur_logo}" alt="${site.operateur_nom}" style="width: 20px; height: auto;">
                        <b>${site.nom}</b><br>
                        ${site.localite}<br>
                        <a href="/site/${site.id}" class="btn btn-sm">
                            <i class="fa fa-info-circle"></i>
                        </a>
                    </div> 
                `);
                marker.addTo(map);
            }
        });

        // Ajuster la vue de la carte pour inclure tous les marqueurs
        if (bounds.length > 0) {
            map.fitBounds(bounds, { padding: [20, 20] });
        }
    }

    // Gestion des événements pour appliquer les filtres
    $('#departement').on('change', applyFilters);
    $('#commune').on('change', applyFilters);
    $('#operateur').on('change', applyFilters);
    conformiteFilters.forEach(checkbox => checkbox.addEventListener('change', applyFilters));

    // Réinitialiser les filtres
    resetButton.addEventListener('click', function () {
        $('#filterForm')[0].reset();
        $('#departement, #commune, #operateur').val(null).trigger('change');
        applyFilters();
    });

    // Appliquer les filtres au chargement de la page
    applyFilters();
});
</script>

<!-- Gestion de la sidebar -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const filterToggle = document.getElementById('filterToggle');
        const closeSidebar = document.getElementById('closeSidebar');
        const sidebar = document.getElementById('filterSidebar');
        const mapElement = document.getElementById('carteSite');

        function toggleSidebar() {
            if (sidebar.style.right === '-300px') {
                sidebar.style.right = '-1px';
                mapElement.style.marginRight = '300px';
            } else {
                sidebar.style.right = '-300px';
                mapElement.style.marginRight = '0';
            }
            setTimeout(() => {
                map.invalidateSize();
            }, 300);
        }

        function closeSidebarHandler() {
            sidebar.style.right = '-300px';
            mapElement.style.marginRight = '0';
            setTimeout(() => {
                map.invalidateSize();
            }, 300);
        }

        filterToggle.addEventListener('click', toggleSidebar);
        closeSidebar.addEventListener('click', closeSidebarHandler);
    });
</script>

<!-- Gestion des fichiers GeoJSON et des filtres -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const map = window.map; // Carte initialisée
        const layers = {}; // Cache pour les couches chargées
        const departementSelect = $('#departement'); // Utilisation de Select2
        const activeLayers = {}; // Tableau associatif pour suivre les couches actives
        let beninPaysLayer = null; // Référence à la couche BENIN_PAYS.json

        // Fonction pour normaliser les noms (supprime accents, espaces, etc.)
        function normalizeName(name) {
            return name
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "") // Supprime les accents
                .toUpperCase() // Convertit en majuscules
                .replace(/\s+/g, ""); // Supprime les espaces
        }

        // Fonction pour charger une couche GeoJSON
        function loadGeoJsonLayer(url, styleOptions, onLoadCallback) {
            console.log(`Chargement du fichier GeoJSON : ${url}`);
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP ${response.status} lors du chargement : ${url}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Fichier GeoJSON chargé avec succès : ${url}`);
                    const layer = L.geoJSON(data, {
                        style: styleOptions,
                        onEachFeature: function (feature, layer) {
                            const name = feature.properties.NOM || 'Inconnu';
                            layer.bindPopup(`<strong>${name}</strong>`);
                        }
                    });
                    onLoadCallback(layer); // Appel au callback une fois la couche prête
                })
                .catch(error => console.error(`Erreur lors du chargement de ${url} :`, error));
        }

        // Fonction pour activer une couche GeoJSON
        function activateLayer(url, styleOptions) {
            // Vérifier si la couche est déjà dans le cache
            if (layers[url]) {
                console.log(`La couche ${url} est déjà en cache. Activation.`);
                layers[url].addTo(map); // Ajouter la couche depuis le cache
            } else {
                console.log(`Chargement et activation de la couche : ${url}`);
                loadGeoJsonLayer(url, styleOptions, function (layer) {
                    layer.addTo(map);
                    layers[url] = layer; // Ajouter la couche au cache
                });
            }
        }

        // Fonction pour supprimer une couche GeoJSON
        function deactivateLayer(url) {
            if (layers[url]) {
                console.log(`Suppression de la couche : ${url}`);
                map.removeLayer(layers[url]);
                delete activeLayers[url]; // Supprimer des couches actives
            }
        }

        // Fonction pour supprimer la couche BENIN_PAYS.json si elle est présente
        function removeBeninPaysLayer() {
            if (beninPaysLayer) {
                console.log("Suppression de la couche BENIN_PAYS.json.");
                map.removeLayer(beninPaysLayer); // Retirer la couche BENIN_PAYS
                beninPaysLayer = null; // Réinitialiser la référence
            }
        }

        // Fonction pour gérer les départements sélectionnés
        departementSelect.on('change', function () {
            const selectedDepartments = departementSelect.select2('data'); // Récupère les départements sélectionnés
            console.log('Départements sélectionnés :', selectedDepartments);

            // Créer un tableau des noms normalisés des départements actuellement sélectionnés
            const selectedUrls = selectedDepartments.map(department => {
                const departmentName = department.text; // Nom du département
                const normalizedDepartment = normalizeName(departmentName); // Normaliser le nom
                return `/static/geojson/${normalizedDepartment}.geojson`;
            });

            // Supprimer toutes les couches actives qui ne sont plus sélectionnées
            Object.keys(activeLayers).forEach(url => {
                if (!selectedUrls.includes(url)) {
                    deactivateLayer(url); // Supprimer la couche de la carte
                }
            });

            // Si aucun département n'est sélectionné, charger BENIN_PAYS.json
            if (selectedUrls.length === 0) {
                console.log("Aucun département sélectionné. Chargement de BENIN_PAYS.json.");
                removeBeninPaysLayer(); // Supprimer BENIN_PAYS si elle était affichée
                activateLayer('/static/geojson/BENIN_PAYS.json', { color: 'blue', weight: 2 }, function (layer) {
                    beninPaysLayer = layer; // Stocker la référence à la couche BENIN_PAYS
                });
                return;
            }

            // Sinon, activer les couches pour les départements actuellement sélectionnés
            removeBeninPaysLayer(); // Supprimer la couche BENIN_PAYS si elle était active
            selectedUrls.forEach(url => {
                if (!activeLayers[url]) {
                    console.log(`Activation de la couche : ${url}`);
                    activateLayer(url, { color: 'red', weight: 3 });
                    activeLayers[url] = layers[url]; // Ajouter la couche aux actives
                }
            });
        });

        // Charger la couche par défaut (BENIN_PAYS.json) au chargement de la page
        activateLayer('/static/geojson/BENIN_PAYS.json', { color: 'blue', weight: 2 }, function (layer) {
            beninPaysLayer = layer; // Stocker la référence à la couche BENIN_PAYS
        });
    });
</script>
{% endblock javascripts %}
